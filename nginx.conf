events {}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Use all available CPU cores (optimal for Raspberry Pi)
    worker_processes auto;
    worker_connections 1024;

    # Enable gzip compression for older browsers
    gzip on;
    gzip_comp_level 6;  # Reasonable level (fast + effective)
    gzip_vary on;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        text/javascript;

    # Enable Brotli compression (preferred if supported by browser)
    brotli on;
    brotli_static on;  # Serve precompressed .br files created at build time
    brotli_comp_level 6;
    brotli_types
        text/plain
        text/css
        application/json
        application/javascript
        text/javascript;

    server {
        listen 80;
        server_name _;

        root /usr/share/nginx/html;
        index index.html;

        # Cache static assets aggressively (Angular generates hashed filenames)
        # These files never change and can be cached for 1 year
        location ~* \.(css|js|png|jpg|jpeg|gif|svg|ico|webp)$ {
            try_files $uri =404;
            expires 1y;
            access_log off;
            add_header Cache-Control "public, immutable";
        }

        # Main route for Angular SPA
        location / {
            # Prefer Brotli or gzip precompressed versions if browser supports them
            add_header Vary "Accept-Encoding";

            # Disable ETag to avoid conflicting cache validators for Angular
            etag off;

            # Angular fallback: serve index.html for unknown routes
            try_files $uri $uri/ /index.html;
        }
    }
}
